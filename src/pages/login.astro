---
import Layout from "../layouts/Layout.astro";
import { ui } from "../i18n/ui.js";

const locale = Astro.locals.lang ?? "en";
const user = Astro.locals.user;

// Si l'utilisateur est déjà connecté, on le redirige vers la page d'accueil
if (user) {
  return Astro.redirect("/");
}

// Texte de la page login côté serveur
const uiLogin = ui[locale].login;
let errorMessage = "";
let successMessage = "";
---
<Layout title={ui[locale].nav.login} lang={locale}>
  <div class="flex items-center justify-center min-h-screen">
    <div class="card w-full max-w-md shadow-xl bg-base-100 p-6">
      <h1 class="card-title text-3xl mb-4 justify-center">{ui[locale].nav.login}</h1>

      <form id="login-form" class="flex flex-col gap-4">
        <input
          type="email"
          name="email"
          placeholder={uiLogin.emailPlaceholder || "Email"}
          class="input input-bordered w-full"
          required
        />
        <input
          type="password"
          name="password"
          placeholder={uiLogin.passwordPlaceholder || "Mot de passe"}
          class="input input-bordered w-full"
          required
        />
        <button type="submit" class="btn btn-secondary w-full">{ui[locale].nav.login}</button>
      </form>

      <p id="status" class="mt-4 text-center text-error">{errorMessage}</p>
      <p id="success" class="mt-4 text-center text-secondary">{successMessage}</p>

      <p class="text-center mt-2">
        {ui[locale].nav.loginmessage} ? <a href="/signup" class="link link-primary">{ui[locale].nav.signin}</a>
      </p>
    </div>
  </div>

  <script>
    //@ts-nocheck
    const form = document.getElementById("login-form");
    const status = document.getElementById("status");
    const success = document.getElementById("success");

    // Supprime l'ancien user
    localStorage.removeItem("user");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      try {
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: formData.get("email"),
            password: formData.get("password"),
          }),
          credentials: "include",
        });

        const resData = await res.json();

        if (!res.ok) {
          throw new Error(resData.error || "Email ou mot de passe invalide");
        }

        // Sauvegarde les infos utilisateur
        localStorage.setItem("user", JSON.stringify(resData.user));

        // Affiche message succès
        success.textContent = "✅ Connexion réussie !";
        status.textContent = ""; // on vide le message d'erreur si présent
          window.location.href = "/";
        
      } catch (err) {
        console.error(err);
        status.textContent = "❌ " + (err.message || "Erreur lors de la connexion");
        success.textContent = "";
      }
    });
  </script>
</Layout>
