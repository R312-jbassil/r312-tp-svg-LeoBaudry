---
import Layout from "../layouts/Layout.astro";
import pb from "../utils/pb";
import { Collections } from "../utils/pocketbase-typegen.ts";
import { ui } from "../i18n/ui.js";

const locale = Astro.locals.lang ?? "en";
const user = Astro.locals.user;

let errorMessage = "";
let successMessage = "";
---

<Layout title={ui[locale].signup.title} lang={locale}>
  <div class="flex items-center justify-center min-h-screen">
    <div class="card w-full max-w-md shadow-xl bg-base-100 p-6">
      <h1 class="card-title text-3xl mb-4 justify-center">{ui[locale].signup.title}</h1>

<form id="signup-form" class="flex flex-col gap-4">
  <input
    type="email"
    name="email"
    placeholder={ui[locale].signup.emailPlaceholder}
    class="input input-bordered w-full"
    required
  />
  <input
    type="password"
    name="password"
    placeholder={ui[locale].signup.passwordPlaceholder}
    class="input input-bordered w-full"
    required
  />
  <button type="submit" class="btn btn-secondary w-full">{ui[locale].signup.submitButton}</button>
</form>


      <p id="status" class="mt-4 text-center text-error">{errorMessage || successMessage}</p>
      <p class="text-center mt-2">
        {ui[locale].nav.signinmessage} <a href="/login" class="link link-primary">{ui[locale].signup.loginLink}</a>
      </p>
    </div>
  </div>

  <script>
    //@ts-nocheck
    const form = document.getElementById("signup-form");
    const status = document.getElementById("status");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const email = formData.get("email");
      const password = formData.get("password");

      try {
        const res = await fetch("/api/signup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
          credentials: "include",
        });

        const resData = await res.json();

        if (!res.ok) {
          throw new Error(resData.error || ui[locale].signup.errorMessage);
        }

        localStorage.setItem("user", JSON.stringify(resData.user));
        status.textContent = "✅ " + (ui[locale].signup.successMessage || "Inscription réussie !");

        window.location.href = "/generator";
      } catch (err) {
        console.error(err);
        status.textContent = "❌ " + (err.message || ui[locale].signup.errorMessage);
      }
    });
  </script>
</Layout>
