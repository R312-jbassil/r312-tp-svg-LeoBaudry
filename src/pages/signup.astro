---
import Layout from "../layouts/Layout.astro";
import { ui } from "../i18n/ui.js";

const locale = Astro.locals.lang ?? "en";
const user = Astro.locals.user;

// Redirection si déjà connecté
if (user) {
  return Astro.redirect("/");
}

let errorMessage = "";
let successMessage = "";
---

<Layout title={ui[locale].signup.title} lang={locale}>
  <div class="flex items-center justify-center min-h-screen">
    <div class="card w-full max-w-md shadow-xl bg-base-100 p-6">
      <h1 class="card-title text-3xl mb-4 justify-center">{ui[locale].signup.title}</h1>

      <form id="signup-form" class="flex flex-col gap-4 w-full">
        <input
          type="email"
          name="email"
          placeholder={ui[locale].signup.emailPlaceholder}
          class="input input-bordered w-full"
          required
        />
        <input
          type="password"
          name="password"
          placeholder={ui[locale].signup.passwordPlaceholder}
          class="input input-bordered w-full"
          required
        />
        <button type="submit" class="btn btn-secondary w-full">{ui[locale].signup.submitButton}</button>
      </form>

      <p id="status" class="mt-4 text-center text-error"></p>
      <p class="text-center mt-2">
        {ui[locale].signup.loginMessage} <a href="/login" class="link link-primary">{ui[locale].signup.loginLink}</a>
      </p>
    </div>
  </div>

  <script>
    //@ts-nocheck
    const form = document.getElementById("signup-form");
    const status = document.getElementById("status");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const email = formData.get("email");
      const password = formData.get("password");

      try {
        const res = await fetch("/api/signup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
          credentials: "include",
        });

        const resData = await res.json();

        if (!res.ok) {
          throw new Error(resData.error);
        }

        // Message de succès en vert (tailwind daisyUI : text-secondary)
        status.textContent = "✅ " + (resData.message || "Inscription réussie !");
        status.classList.remove("text-error");
        status.classList.add("text-secondary");

        // Sauvegarde localStorage
        localStorage.setItem("user", JSON.stringify(resData.user));

        // Redirection après un court délai
        setTimeout(() => {
          window.location.href = "/generator";
        }, 800);

      } catch (err) {
        console.error(err);
        status.textContent = "❌ " + (err.message || "Erreur lors de l'inscription");
        status.classList.remove("text-secondary");
        status.classList.add("text-error");
      }
    });
  </script>
</Layout>
